{% macro people_list_pagenav(people, page=None, pagesize=None) -%}
    <div class="float-list">
        {% call(person) list_pagenav(people, page=page, pagesize=pagesize) %}
            {{widgets.card(person)|safe}}
        {% endcall %}
    </div>
{%- endmacro %}

{% macro people_list_more(people, url, pagesize=None) -%}
    <div class="float-list">
        {% call(person) list_more(people, url, pagesize=pagesize) %}
            {{widgets.card(person)|safe}}
        {% endcall %}
    </div>
{%- endmacro %}

{% macro btn_show(target, show=None, hide=None) -%}
{% set show = show or gettext('show') %}
{% set hide = hide or gettext('hide') %}
<a href="#" class="btn-show" data-target="{{target}}">
    <span class="text-show">{{show}}</span><span class="text-hide">{{hide}}</span>
</a>
{%- endmacro %}

{% macro list_count(query, type=None) -%}
    {% set cnt = query|count if hasattr(query, 'append') else query.count() %}
    <span class="search-count">{% if type=='people' %}{{ gettext('%(count)d people', count=cnt) }}{% else %}{{ gettext('%(count)d results', count=cnt) }}{% endif %}</span>
{%- endmacro %}

{% macro list_pagenav(query, page=None, pagesize=None, l=2, layout='list') -%}
    {% set page = int(request.args.get('page', 1)) %}
    {% set pagesize = pagesize or 20 %}
    {% set prev_url = url_for_query(page=max(1, page - 1)) %}
    {% set next_url = url_for_query(page=page + 1) %}
    {% set offset = (page - 1) * pagesize %}
    {% set items = query.offset(offset).limit(pagesize+1).all() %}
    {% set num_items_left = max(query.offset(offset).count() - pagesize, 0) %}
    {% set num_pages_left = int((num_items_left + pagesize - 1) / pagesize) %}

    {% if layout=='list' %}
        <ul>
        {% for item in items[:pagesize] %}
            <li>{{caller(item)}}</li>
        {% endfor %}
        </ul>
    {% elif layout=='table' %}
        <table class="table table-condensed">
        {% for item in items[:pagesize] %}
            <tr>{{caller(item)}}</tr>
        {% endfor %}
        </table>
    {% endif %}

    <div class="pagenav">
        {% if 1 <= page-l-1 %}
            <a class="btn-pagenav btn-prev" href="{{ url_for_query(page=1) }}"><i class="icon-double-angle-left"></i></a>
            <a class="btn-pagenav btn-prev" href="{{ url_for_query(page=page-l-1) }}"><i class="icon-angle-left"></i></a>
        {% endif %}
        {% for p in range(max(page-l, 1), page+min(num_pages_left, l)+1) %}
            <a class="btn-pagenav{% if p == page %} active{% endif %}" href="{{ url_for_query(page=p) }}">{{ p }}</a>
        {% endfor %}
        {% if l < num_pages_left %}
            <a class="btn-pagenav btn-next" href="{{ url_for_query(page=page+l+1) }}"><i class="icon-angle-right"></i></a>
            <a class="btn-pagenav btn-next" href="{{ url_for_query(page=page+num_pages_left) }}"><i class="icon-double-angle-right"></i></a>
        {% endif %}
    </div>
{%- endmacro %}

{% macro list_more_ajax(url, pagesize=None) -%}
    {% set pagesize = pagesize or 20 %}
    {% set guids = guid_factory() %}

    <script type="template/mustache" id="{{ guids('template') }}">
        <li>{{ caller() }}</li>
    </script>
    <ul id="{{ guids('list') }}">
    </ul>

    <script>
    (function () {
        var tmpl = $("#{{ guids('template') }}").html(),
            $list = $("#{{ guids('list') }}"),
            page = 1;

        function retrieve() {
            $.get("{{ url|safe }}", {
                page: page,
                pagesize: {{ pagesize }}
            }, function (res) {
                res = JSON.parse(res);
                $.each(res.data, function (i, item) {
                    var html = Mustache.render(tmpl, item),
                        $elem = $(html);
                    $elem.appendTo($list);
                });
                if (!res.has_more) {
                    $("#{{ guids('btn') }}").hide();
                }
            });
            page += 1;
            return false;
        }

        $(function () {
            retrieve();
        });

        window.f{{ guids('func') }} = retrieve;
    }());
    </script>

    <a id="{{ guids('btn') }}" class="btn-more" href="#" onclick="f{{ guids('func') }}()">{{ gettext('more') }}</a>
{%- endmacro %}

{% macro list_more(query, url, pagesize=None, layout='list', more=True) -%}
    {% set pagesize = pagesize or 20 %}
    {% set items = query.limit(pagesize+1).all() %}

    {% if layout=='list' %}
        <ul>
        {% for item in items[:pagesize] %}
            <li>{{caller(item)}}</li>
        {% endfor %}
        </ul>
    {% elif layout=='table' %}
        <table class="table table-condensed">
        {% for item in items[:pagesize] %}
            <tr>{{caller(item)}}</tr>
        {% endfor %}
        </table>
    {% endif %}

    {% if more and items|count > pagesize %}
    <a class="btn-more" href="{{ url }}">{{ gettext('more') }}</a>
    {% endif %}
{%- endmacro %}

{% macro bill_with_fallback_date(bill) -%}
    {{ bill.proposed_date or (bill.decision_date and '%d-00-00' % bill.decision_date.year) or gettext("date unknown") }} <a href="{{ url_for('bill', id=bill.id) }}">{{ bill.name }}</a>
{%- endmacro %}
